name: CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - main

jobs:
  tests:
    uses: ./.github/workflows/test-reusable.yml

  deploy:
    name: Deploy to Vercel
    needs: tests
    runs-on: ubuntu-latest
    env:
      IS_PROD: ${{ github.ref == 'refs/heads/main' }}
      # Zorg dat deze secrets in je GitHub Settings staan!
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Pull Vercel Environment Information
        run: |
          ENVIRONMENT=$([ "$IS_PROD" = "true" ] && echo "production" || echo "preview")
          vercel pull --yes --environment=$ENVIRONMENT --token "$VERCEL_TOKEN"

      - name: Deploy to Vercel
        id: deploy
        run: |
          if [ "$IS_PROD" = "true" ]; then
            URL=$(vercel deploy --prod --token "$VERCEL_TOKEN" --yes)
          else
            URL=$(vercel deploy --token "$VERCEL_TOKEN" --yes)
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Set Alias
        run: |
          # Pas deze URL's aan naar jouw eigen Vercel domeinen
          ALIAS=$([ "$IS_PROD" = "true" ] && echo "jouw-project.vercel.app" || echo "jouw-project-dev.vercel.app")
          vercel alias set "${{ steps.deploy.outputs.url }}" "$ALIAS" --token "$VERCEL_TOKEN"
